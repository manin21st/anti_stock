# 📘 자동매매 차트표시 기능 명세서

> 기반 시스템: 국내주식 자동매매 anti_stock 프로그램
> 
> 
> 이 문서는 **차트 시각화(Trade Visualization)** 모듈을 추가하기 위한 기능 명세서이다.
> 

---

## 1. 기능 개요

### 1.1 목적

- 자동매매 프로그램이 실행한 **매수/매도/손절/익절/청산** 내역을
    
    캔들 차트 위에 시각적으로 표시하여,
    
    - 전략 동작을 검증하고,
    - 백테스트/실거래 결과를 직관적으로 분석하며,
    - 전략 튜닝 및 디버깅에 활용하는 것을 목표로 한다.

### 1.2 범위

- **대상 데이터**
    - 실거래/모의거래/백테스트로 발생한:
        - 주문, 체결, 포지션, PnL 기록
- **대상 차트**
    - 분봉(1, 3, 5, 10, 15, 30, 60분)
    - 일봉 (향후 주봉/월봉 확장 가능)
- **출력 환경**
    - HTS 스타일의 **2패널 구조**
        - 상단: 캔들 + 이동평균선 + 매매마커
        - 하단: 거래량 + RSI 지표

---

## 2. 용어 정의

- **Trade Event**: 시스템이 기록한 매매 관련 이벤트
    
    (예: ORDER_SUBMITTED, ORDER_FILLED, POSITION_OPENED, POSITION_CLOSED 등)
    
- **Trade Marker**: 차트 위에 표시되는 아이콘/심볼 (화살표, 점, 라벨 등)
- **Session**: 하나의 연속된 자동매매 실행 구간 (날짜 or 전략 실행 ID 기준)
- **Strategy ID**: 각 전략을 구분하기 위한 유니크 식별자

---

## 3. 아키텍처 확장 개요

기존 구조에 다음 컴포넌트를 추가한다.

```
[MarketData] ─────┐
                  ▼
              [Chart Data Adapter] → [Chart UI]
[Portfolio] ──────┘                     ▲
                                        │
[Logging(주문/체결)] → [Trade Visualization Service]
                               │
                               └───────────────┘ (차트에 매매내역 Overlay)

```

- **Chart Data Adapter**
    - 기존 MarketData/Portfolio/로그 데이터를 차트 라이브러리가 이해할 수 있는 구조로 변환
- **Trade Visualization Service**
    - 매매 이벤트를 캔들 데이터와 매칭
    - Trade Marker 계산 및 스타일링
    - 전략/계좌/기간 필터링 로직 담당

---

## 4. 데이터 요구사항

### 4.1 입력 데이터 정의

1. **시세/차트 데이터 (기존 MarketData)**
    - `symbol, timeframe, datetime, open, high, low, close, volume`
2. **거래 로그 데이터**
    - 주문/체결/포지션/손익을 최소 아래 필드로 저장
    - (이미 있는 Logging/Portfolio 모듈 기준으로 확장)

```json
TradeEvent {
  "event_id": string,
  "timestamp": datetime,
  "symbol": string,
  "strategy_id": string,
  "event_type": "ORDER_NEW" | "ORDER_FILLED" | "ORDER_CANCELED" |
                "POSITION_OPENED" | "POSITION_CLOSED" |
                "STOP_LOSS" | "TAKE_PROFIT" | "TRAIL_STOP" |
                "MANUAL_CLOSE",
  "side": "BUY" | "SELL",
  "price": float,
  "qty": int,
  "order_id": string,
  "position_id": string,
  "pnl": float,              // 포지션 종료시
  "pnl_pct": float,          // 포지션 종료시
  "meta": { ... }            // 전략별 추가 정보
}

```

1. **포지션 데이터 (Portfolio Manager 연동)**
    - `position_id, symbol, strategy_id, entry_time, exit_time, entry_price, exit_price, max_price, min_price, pnl, pnl_pct`

### 4.2 데이터 매핑 규칙

- **체결 시각(timestamp)** 이 포함된 캔들(Bar)을 매수/매도 마커의 기준 봉으로 사용
    
    → `timestamp` ∈ [bar_start_time, bar_end_time)
    
- 장외시간 체결(시간외 단일가 등)은 **별도 색상/레이블** 또는 차트 밖 리스트로 처리

---

## 5. 화면(UI) 요구사항

### 5.1 기본 레이아웃

1. **상단 패널**
    - 캔들 차트
    - 이동평균선(예: 5, 10, 20, 60, 120; 기존 HTS 스타일과 유사)
    - 매수/매도/청산 마커
    - 포지션 구간 표시(진입~청산까지 선 또는 배경 강조)
2. **하단 패널**
    - 거래량 막대
    - 선택한 전략의 거래 발생 봉은 **특수 색상**으로 강조 (옵션)
3. **우측/좌측 정보 영역**
    - 선택한 매매 마커의 상세 정보 툴팁 또는 사이드 패널 표시
        - 전략명
        - 매수/매도 구분
        - 가격, 수량, 체결시각
        - 해당 포지션 전체 PnL 정보 (종료된 포지션인 경우)

### 5.2 매매 마커 디자인 요구사항

| 타입 | 표시 위치 | 기본 심볼/색 | 설명 |
| --- | --- | --- | --- |
| 매수 체결 | 캔들 아래 | 초록색 ↑ | BUY FILLED |
| 매도 체결 | 캔들 위 | 빨간색 ↓ | SELL FILLED |
| 손절 | 캔들 위 or 아래 | 붉은 X | STOP_LOSS 이벤트 |
| 익절 | 캔들 위 or 아래 | 별★ or 체크 | TAKE_PROFIT 이벤트 |
| 트레일스탑 | 캔들 위 | 주황색 ▲ | TRAIL_STOP 이벤트 |
| 부분청산 | 캔들 중간 | 반투명 화살표 | 포지션 수량 감소 |

> 구체적인 색/아이콘은 구현단에서 UI 가이드에 따라 변경 가능하나,
> 
> 
> **이벤트 타입별로 시각적으로 명확히 구분**되어야 한다.
> 

### 5.3 포지션 구간 표시

- 포지션이 열린 시간 구간을 **수평 밴드** 또는 **라인**으로 표시
    - 예: 매수 체결 캔들부터 마지막 청산 체결 캔들까지
    - 밴드 색:
        - 수익 포지션: 연한 초록색
        - 손실 포지션: 연한 빨간색
- 옵션:
    - 포지션 당 수익률(%)을 밴드 중앙에 라벨로 표시: `+3.2%`, `1.8%`

---

## 6. 기능 요구사항 (Use Case 기준)

### 6.1 기능 ① – 종목/전략/기간별 차트 조회

**설명**

사용자는 특정 **종목, 전략, 기간**을 선택하여 자동매매 결과가 표시된 차트를 조회할 수 있어야 한다.

**입력**

- symbol (예: 005930)
- timeframe (1, 3, 5, 10, 15, 30, 60, day)
- date_range (예: 2025-12-01 ~ 2025-12-05)
- strategy_filter (단일 전략 또는 전체)
- session_filter (실거래 / 모의 / 백테스트)

**처리**

1. MarketData에서 해당 구간의 캔들 데이터 로드
2. Logging/Portfolio에서 동일 구간의 TradeEvent/포지션 로드
3. TradeEvent를 캔들 시간 구간에 매핑
4. Trade Marker 및 포지션 구간 정보 생성
5. Chart UI에 데이터 전달 및 렌더링

**출력**

- 매매 마커와 포지션 구간이 Overlay 된 캔들 차트

**예외**

- 데이터 없음 → “해당 기간 전략 매매 내역 없음” 메시지 표시
- 시세만 있고 거래가 없는 경우 → 기본 차트만 표시

---

### 6.2 기능 ② – 마커 클릭 시 매매 상세 정보 표시

**설명**

사용자가 차트 상의 매매 마커를 클릭하면 해당 이벤트의 상세정보를 확인할 수 있어야 한다.

**입력**

- 클릭한 마커의 event_id or position_id

**처리**

1. TradeEvent DB/로그에서 해당 event_id 조회
2. 동일 position_id로 연결된 전체 포지션 정보 조회
3. PnL, 보유시간, 최대·최소가격 등 계산
4. 툴팁 혹은 우측 패널에 정보 표시

**출력 (예시)**

- 전략: MovingAverageTrendStrategy
- 이벤트: BUY FILLED
- 종목: 삼성전자(005930)
- 체결가: 107,500원 / 수량: 50주
- 체결시각: 2025-12-05 10:15
- 포지션ID: POS-20251205-001
- 이 포지션 최종 결과: +3.2%, +16,000원 (포지션 종료 시에만)

---

### 6.3 기능 ③ – 전략별/포지션별 색상 구분

**설명**

여러 전략이 같은 종목을 거래하는 경우, 전략별로 마커 색/스타일을 달리 하여 구분 가능해야 한다.

**요구사항**

- 기본 모드: **이벤트 타입 기준 색상(매수/매도/손익)**
- 전략 구분 모드: 전략ID별 기본 색 지정 (예: 전략1: 파랑, 전략2: 보라)
- 사용자가 UI에서 토글:
    - [ ]  `이벤트 기준 색상 / 전략 기준 색상`

---

### 6.4 기능 ④ – PnL 라벨 / 누적 손익 표시

**설명**

사용자가 옵션을 켜면, 포지션 종료 지점에 실현 손익을 라벨로 표시한다.

**요구사항**

- 포지션 종료 시점 캔들 위/아래에 `+15,300(+2.8%)` 형식의 라벨 표시
- 일자별 누적 손익을 차트 상단에 텍스트로 표기 (예: `2025-12-05 전략1 PnL: +85,000원 (+1.2%)`)
- 라벨 표시 여부는 옵션:
    - [x]  `포지션별 PnL 라벨` / `숨김`

---

### 6.5 기능 ⑤ – 백테스트 결과 차트 연동

**설명**

백테스트 엔진이 생성한 결과도 동일한 UI에서 볼 수 있어야 한다.

**요구사항**

- 백테스트 실행 시:
    - 시세 데이터 + 가상 TradeEvent/포지션 로그 생성
- 실거래와 동일 포맷으로 TradeEvent 저장
- Chart UI에서 `Session = 백테스트ID`를 선택해 동일한 방식으로 표시
- 실제 API 호출 없이도, 동일 UX로 전략 검증 가능

---

### 6.6 기능 ⑥ – 필터 / 레이어 컨트롤

**설명**

사용자가 차트에 어떤 정보 레이어를 표시할지 선택할 수 있어야 한다.

**옵션 항목**

- [x]  이동평균선 (5/10/20/60/120)
- [x]  매수/매도 마커
- [x]  손절/익절/트레일스탑 마커
- [x]  포지션 구간 표시
- [ ]  PnL 라벨
- [ ]  전략별 색상 모드

모든 옵션은 즉시 적용(차트 재렌더링)되어야 한다.

---

## 7. 비기능 요구사항

### 7.1 성능

- 1개 종목, 1일 1분봉 기준(약 400봉 내외 + 다수 TradeEvent)에서:
    - 차트 최초 렌더링 시간: 1초 이내
    - 레이어 토글/줌/스크롤 시 0.5초 이내 반응

### 7.2 확장성

- 추후 **해외주식 / 파생 / 코인** 등으로 확장 가능하도록,
    - 심볼 포맷, 거래시간, 수수료 구조를 UI에서는 추상화
- 차트 엔진은
    - Desktop (WPF/WinForm/JavaFX) or Web(HTML/JS) 중 교체 가능하도록
    - `IChartRenderer` 인터페이스 정의 후 구현체 분리

### 7.3 로깅/추적성

- 차트에 표시된 모든 마커는 로그 상의 event_id와 1:1 매핑 가능해야 한다.
- 사용자 문의/버그 리포트 시,
    - “2025-12-05 삼성전자 10:15 매수 마커 이상” → event_id를 통해 원인 추적 가능

---

## 8. 모듈 설계 초안

### 8.1 TradeVisualizationService 인터페이스

```python
class TradeVisualizationService:
    def get_chart_data(self, symbol, timeframe, date_range, strategy_filter, session_filter):
        """
        반환:
          {
            "bars": [Bar...],
            "trade_markers": [TradeMarker...],
            "positions": [VisualPosition...]
          }
        """
        ...

class TradeMarker:
    event_id: str
    symbol: str
    strategy_id: str
    event_type: str
    timestamp: datetime
    price: float
    side: str  # BUY/SELL
    marker_type: str  # BUY, SELL, STOP_LOSS, TAKE_PROFIT, etc.
    style: dict       # color, shape, size 등 UI 레이어에서 사용

class VisualPosition:
    position_id: str
    symbol: str
    strategy_id: str
    entry_time: datetime
    exit_time: datetime
    entry_price: float
    exit_price: float
    pnl: float
    pnl_pct: float
    is_profit: bool

```

### 8.2 ChartRenderer 인터페이스

```python
class IChartRenderer:
    def render(self, bars, trade_markers, positions, options):
        """UI 환경에 따라 구현 (WPF, Web 등)"""
        ...

```

---

## 9. 테스트 시나리오 (요약)

1. **단일 포지션 시나리오**
    - 5분봉 기준 1회 매수/1회 매도 → 마커 2개 + 포지션 밴드 1개 표시 확인
2. **부분청산 시나리오**
    - 1회 매수, 2회 매도(부분청산) → 매도 마커 2개, 포지션 밴드 1개, PnL 라벨 검증
3. **백테스트 결과 표시**
    - 백테스트 로그를 기반으로 차트 표시
    - 실거래와 동일한 UI/기능 제공 여부 확인
4. **성능 테스트**
    - 1종목 3개월치 1분봉 + TradeEvent 다량 → 줌/스크롤/토글 반응 시간 측정

---